# 项目规范与行为准则

> 本文档为 AI 助手（如 GPT-4、Claude 等）提供项目上下文和行为规范，帮助 AI 更好地理解项目需求并提供高质量的代码建议。

---

## 1. 项目概述

### 1.1 项目背景

**项目名称**: Headshot AI Web App (移动端)

**项目定位**: 为职业用户提供 AI 驱动的职业照片生成服务

**核心功能**:
- 浏览并选择模特照片和素材（场景、服装、姿势、发型）
- 上传用户自己的照片
- 通过 AI 合成专业的 Headshot 照片

### 1.2 产品服务类型

项目提供 5 种 Headshot 生成服务：

| 服务类型 | 说明 | 默认生成数量 |
|---------|------|------------|
| **1P** | 使用 app 提供的模特图 | 1 张 |
| **20P** | 使用 app 提供的素材（场景、服装、姿势、发型） | 20 张 |
| **40P** | 使用 app 提供的素材（场景、服装、姿势、发型） | 40 张 |
| **80P** | 使用 app 提供的素材（场景、服装、姿势、发型） | 80 张 |
| **DIY** | 使用用户上传的素材照片 | 1 张 |

**重要特性**:
- 用户可选择多张自己上传的照片，生成数量相应翻倍
- 每种服务有独立的金币价格和任务耗时

---

## 2. 技术架构

### 2.1 技术栈

**前端框架**:
- Vue 3.5.19 (Composition API)
- TypeScript 5.9.2
- Vite 5.4.19 (构建工具)

**UI 框架**:
- Ionic Vue 8.7.3
- Ionicons 7.0.0 (仅在部分支付相关页面使用)

**移动端支持**:
- Capacitor 7.4.3 (PWA 和原生应用支持)
- 支持 iOS 和 Android

**其他依赖**:
- Vue Router 4.2.0
- Axios 1.11.0

**图标系统**:
- 使用自定义 SVG 图标（通过 `SvgIcon.vue` 组件）
- 所有图标文件存储在 `public/images/icons/` 目录
- 支持自定义尺寸和颜色

**测试工具**:
- Cypress 13.5.0 (E2E 测试)
- Vitest 0.34.6 (单元测试)

### 2.2 项目类型

- **PWA 应用**: 支持离线访问和安装到主屏幕
- **单页应用 (SPA)**: 只有一个主页面，其他功能通过全屏弹窗实现
- **移动端优先**: 仅支持手机端，不支持 PC 和平板

### 2.3 后端集成

- 后端使用 Python + Flask
- 前端通过 RESTful API 与后端通信
- 后端项目已独立拆分，本项目仅包含前端代码

---

## 3. 代码规范

### 3.1 目录结构规范

```
src/
├── bootstrap/          # 应用启动模块
├── components/         # 可复用组件
│   ├── pageLike/      # PageLikeModal 核心组件
│   ├── uploadPhoto/   # 照片上传相关组件
│   └── ...
├── composables/        # 组合式函数（全局）
├── pages/             # 页面级组件
│   ├── homepage/      # 主页
│   ├── generator/     # AI 生成器
│   ├── sideMenu/      # 侧边菜单
│   └── ...
├── services/          # API 服务层
├── state/             # 全局状态管理
├── types/             # TypeScript 类型定义
├── utils/             # 工具函数
└── theme/             # 样式主题
```

### 3.2 命名规范

| 类型 | 规范 | 示例 |
|-----|------|------|
| **组件文件** | PascalCase | `HomeHeader.vue`, `CategoryPanels.vue` |
| **组合式函数** | use 前缀 + camelCase | `usePersistentModal`, `useMenuManagement` |
| **服务函数** | 动词开头 + camelCase | `fetchDemoHomePage`, `uploadImage` |
| **类型定义** | PascalCase | `TabItem`, `MenuItem`, `FaceUploadExpose` |
| **常量** | UPPER_SNAKE_CASE | `MAX_THUMBS`, `API_BASE_URL` |

### 3.3 代码风格

**Vue 组件**:
```vue
<script setup lang="ts">
// 使用 Composition API 和 TypeScript
import { ref, computed } from 'vue';

interface Props {
  title: string;
  count?: number;
}

const props = withDefaults(defineProps<Props>(), {
  count: 0
});

const emit = defineEmits<{
  click: [id: string];
}>();
</script>
```

**组合式函数**:
```typescript
export function useFeature() {
  const state = ref<string>('');
  
  const computedValue = computed(() => {
    return state.value.toUpperCase();
  });
  
  const action = () => {
    // 实现逻辑
  };
  
  return {
    state,
    computedValue,
    action
  };
}
```

### 3.4 TypeScript 规范

- 使用 `interface` 而非 `type` 定义对象类型
- 类型定义统一放在 `types/` 目录
- 组件 props 和 emits 必须有类型定义
- 避免使用 `any`，使用 `unknown` 或具体类型

### 3.5 CSS 规范

- 优先使用 Ionic 组件的内置样式
- 自定义样式使用 scoped CSS
- 全局样式变量定义在 `theme/variables.css`
- 移动端样式定义在 `theme/mobile-navigation.css`

---

## 4. 交互规范

### 4.1 页面架构

**单页应用架构**:
- 只有一个主页面 (`HomePage.vue`)
- 所有其他功能通过全屏弹窗实现
- 使用 `PageLikeModal.vue` 组件模拟页面体验

**PageLikeModal 特性**:
- 全屏显示，外观类似普通页面
- 支持标题栏（可包含文字、tabs、图标）
- 支持返回/关闭按钮
- 支持滑动退出手势
- 支持 Tab 状态持久化

### 4.2 导航模式

**主要导航方式**:
1. 顶部导航菜单栏（主页）
2. 侧边菜单（设置、用户中心等）
3. 全屏弹窗（各功能页面）
4. 手势导航（滑动切换、滑动退出）

**历史控制**:
- 防止用户通过浏览器后退按钮离开应用
- 支持应用内导航的同时阻止意外退出
- Safari/iOS 特殊兼容性处理

### 4.3 手势交互

- **Tab 切换**: 左右滑动切换标签页
- **弹窗退出**: 垂直或水平滑动关闭弹窗
- **列表滚动**: 原生滚动体验
- **图片预览**: 支持缩放和滑动

---

## 5. 语言规范

### 5.1 用户界面文本

**规则**: 所有用户可见的文本使用英文

**包括**:
- UI 标签和按钮文字
- 提示信息和错误消息
- 表单标签和占位符
- 服务端返回并展示给用户的内容

**示例**:
```typescript
// ✅ 正确
const message = 'Upload successful';
const buttonText = 'Generate';

// ❌ 错误
const message = '上传成功';
const buttonText = '生成';
```

### 5.2 代码注释

**规则**: 注释使用中文，专有名词保持英文

**示例**:
```typescript
// ✅ 正确
// 从 localStorage 加载选中状态
const loadSelection = () => {
  // 获取缓存的 URL 列表
  const cached = localStorage.getItem('selected_urls');
  return cached ? JSON.parse(cached) : [];
};

// ❌ 错误
// Load selection from localStorage
const loadSelection = () => {
  // Get cached URL list
  const cached = localStorage.getItem('selected_urls');
  return cached ? JSON.parse(cached) : [];
};
```

### 5.3 调试输出

**规则**: 调试信息使用英文

**示例**:
```typescript
// ✅ 正确
console.log('[FaceUploadedPage] Loaded faces from server:', faces);
console.error('[API] Failed to fetch data:', error);

// ❌ 错误
console.log('[FaceUploadedPage] 从服务器加载的人脸:', faces);
console.error('[API] 获取数据失败:', error);
```

---

## 6. 行为准则

### 6.1 代码实现原则

**简洁优先**:
- 用最简单的方式完成需求
- 避免过度设计和不必要的抽象
- 优先使用现有组件和工具函数

**CSS 优先**:
- 界面效果优先考虑用 CSS 实现
- 动画效果使用 CSS transitions/animations
- 只有 CSS 无法实现时才使用 JavaScript

**调试友好**:
- 在关键位置输出调试信息到控制台
- 使用有意义的日志前缀（如 `[ComponentName]`）
- 错误信息要清晰明确

### 6.2 代码修改策略

**评估复杂度**:
- 修复 bug 时，如果需要增加 100 行以上代码，先评估是否有更简洁的方案
- 如果没有更简洁的方案，再执行当前方案

**严格等效转换**:
- 提取、封装组件时，确保不破坏现有业务逻辑
- 重构前后的行为必须完全一致
- 充分测试边界情况

**充分思考**:
- 在提出解决方案前，充分考虑可能的方案
- 找到最合理的方案，不要编造不合理的方案
- 考虑方案的可维护性和扩展性

### 6.3 任务执行规范

**专注当前任务**:
- 只修改与当前任务相关的文件
- 如果发现无关文件被修改或存在错误，请忽略（可能是其他任务在修改）
- 不要在当前任务中修复无关的问题

**任务完成后**:
- ❌ 不要创建 `.md` 文档（除非明确要求）
- ❌ 不要执行 `git commit`（除非明确要求）
- ❌ 不要执行 `git push`（除非明确要求）
- ✅ 简洁地总结完成的工作
- ✅ 说明修改的文件和主要变更

### 6.4 代码质量要求

**类型安全**:
- 充分利用 TypeScript 的类型系统
- 避免使用 `any`，使用具体类型或 `unknown`
- 为所有函数参数和返回值定义类型

**错误处理**:
- 所有异步操作必须有错误处理
- 用户操作失败时提供清晰的错误提示
- 网络请求失败时提供重试机制

**性能考虑**:
- 避免不必要的重新渲染
- 大列表使用虚拟滚动或分页
- 图片使用懒加载和预加载策略

---

## 7. 核心概念

### 7.1 PageLikeModal 组件

**用途**: 创建全屏弹窗，模拟页面体验

**主要特性**:
- 统一使用 `IonModal` 实现
- 支持多种标题类型（simple、icon-tabs、text-tabs）
- 内置滑动退出动画
- 支持 Tab 状态持久化
- 模态框层级管理

**使用示例**:
```vue
<PageLikeModal 
  :is-open="showPage" 
  page-title="Settings" 
  modal-style="vertical" 
  title-type="simple"
  modal-type="SettingsModal"
  @close="closePage"
>
  <div>页面内容</div>
</PageLikeModal>
```

### 7.2 组合式函数架构

**设计理念**: 功能模块化，提高代码复用性和可测试性

**分类**:
- **全局组合式函数** (`composables/`): 跨组件使用
- **页面级组合式函数** (`pages/*/composables/`): 特定页面使用
- **组件级组合式函数** (`components/*/composables/`): 特定组件使用

**命名规范**: `use` + 功能描述

**示例**:
```typescript
// composables/usePersistentModal.ts
export function usePersistentModal(key: string) {
  const isOpen = ref(false);
  
  // 从 sessionStorage 加载状态
  onMounted(() => {
    const saved = sessionStorage.getItem(key);
    if (saved) isOpen.value = JSON.parse(saved);
  });
  
  // 保存状态到 sessionStorage
  watch(isOpen, (value) => {
    sessionStorage.setItem(key, JSON.stringify(value));
  });
  
  return { isOpen };
}
```

### 7.3 状态管理

**当前方案**: 使用 `reactive`/`ref` + 模块化 state

**核心状态模块**:
- `authState.ts`: 认证和会话信息
- `uiState.ts`: UI 状态（弹窗可见性等）
- `newUserSettings.ts`: 新用户设置

**持久化策略**:
- `sessionStorage`: 会话级别（页面刷新保留，关闭浏览器清除）
- `localStorage`: 永久保存（用户手动清除或代码清除）

**未来扩展**: 如果复杂度提升，可迁移至 Pinia

### 7.4 服务层设计

**职责**: 封装所有后端 API 调用

**优势**:
- 错误集中处理
- 便于切换 baseURL 或添加鉴权 header
- 便于 mock 和测试

**示例**:
```typescript
// services/imageService.ts
export async function fetchDemoHomePage(
  category: string, 
  page: number
): Promise<{ images: string[]; page: number; has_more: boolean }> {
  const response = await axios.get('/api/demo_home', {
    params: { category, page }
  });
  return response.data;
}
```

---

## 8. 常见任务指南

### 8.1 创建新页面

**步骤**:
1. 在 `pages/` 下创建新目录
2. 创建 `index.vue` 作为页面主组件
3. 使用 `PageLikeModal` 包装页面内容
4. 在 `App.vue` 中添加弹窗状态管理
5. 在需要的地方添加打开页面的入口

**示例**:
```vue
<!-- pages/myFeature/index.vue -->
<template>
  <PageLikeModal
    :is-open="props.isOpen"
    page-title="My Feature"
    modal-style="vertical"
    @close="emit('close')"
  >
    <div class="content">
      <!-- 页面内容 -->
    </div>
  </PageLikeModal>
</template>

<script setup lang="ts">
interface Props {
  isOpen: boolean;
}

const props = defineProps<Props>();
const emit = defineEmits<{ close: [] }>();
</script>
```

### 8.2 添加新的 API 调用

**步骤**:
1. 在 `services/` 下创建或更新服务文件
2. 定义请求和响应的 TypeScript 类型
3. 实现 API 调用函数
4. 添加错误处理和重试逻辑

**示例**:
```typescript
// services/myService.ts
import axios from 'axios';

interface MyDataResponse {
  data: string[];
  total: number;
}

export async function fetchMyData(): Promise<MyDataResponse> {
  try {
    const response = await axios.get('/api/my-data');
    return response.data;
  } catch (error) {
    console.error('[MyService] Failed to fetch data:', error);
    throw error;
  }
}
```

### 8.3 创建组合式函数

**步骤**:
1. 确定功能范围和职责
2. 在合适的位置创建文件（全局或局部）
3. 定义清晰的输入参数和返回值
4. 实现功能逻辑
5. 添加必要的注释

**示例**:
```typescript
// composables/useCounter.ts
import { ref, computed } from 'vue';

export function useCounter(initialValue = 0) {
  const count = ref(initialValue);
  
  const doubleCount = computed(() => count.value * 2);
  
  const increment = () => {
    count.value++;
  };
  
  const decrement = () => {
    count.value--;
  };
  
  const reset = () => {
    count.value = initialValue;
  };
  
  return {
    count,
    doubleCount,
    increment,
    decrement,
    reset
  };
}
```

### 8.4 添加新组件

**步骤**:
1. 确定组件的职责和复用性
2. 在 `components/` 下合适的分类目录创建组件
3. 定义清晰的 Props 和 Emits 接口
4. 实现组件逻辑和样式
5. 添加必要的文档注释

**示例**:
```vue
<!-- components/myCategory/MyComponent.vue -->
<template>
  <div class="my-component">
    <h2>{{ title }}</h2>
    <button @click="handleClick">{{ buttonText }}</button>
  </div>
</template>

<script setup lang="ts">
interface Props {
  title: string;
  buttonText?: string;
}

const props = withDefaults(defineProps<Props>(), {
  buttonText: 'Click me'
});

const emit = defineEmits<{
  click: [id: string];
}>();

const handleClick = () => {
  emit('click', 'some-id');
};
</script>

<style scoped>
.my-component {
  padding: 16px;
}
</style>
```

---

## 9. 文档说明

### 9.1 必读文档

在开始工作前，请阅读以下文档：

1. **项目说明.md**: 了解项目的整体架构和代码结构
2. **package.json**: 了解项目依赖和可用脚本
3. **tsconfig.json**: 了解 TypeScript 配置
4. **README.md** (如果存在): 了解项目的基本信息

### 9.2 文档更新原则

**何时更新文档**:
- 项目架构发生重大变化
- 添加了新的核心功能或模块
- 修改了重要的设计决策
- 发现文档与实际代码不符

**如何更新文档**:
- 保持文档简洁明了
- 使用表格和列表提高可读性
- 添加代码示例说明用法
- 更新目录结构和文件说明

**文档优先级**:
- 实际代码 > 文档说明
- 如果文档与代码不符，以代码为准
- 发现不符时，更新文档以匹配代码

---

## 10. 立即行动

### 10.1 初始化任务

在开始协助开发前，请执行以下步骤：

1. **阅读项目文档**:
   - 阅读 `项目说明.md`
   - 浏览 `package.json` 了解依赖
   - 查看 `src/` 目录结构

2. **分析代码逻辑**:
   - 理解核心组件的实现
   - 了解状态管理方式
   - 熟悉 API 服务层

3. **检查文档一致性**:
   - 对比文档与实际代码
   - 如果发现不一致，记录下来

4. **反馈结果**:
   - 如果需要更新文档，立即执行并回复："明白，已经调整说明文档"
   - 如果文档准确，回复："明白，已经阅读相关文档。无需调整说明文档"

### 10.2 工作流程

在后续的开发协助中，请遵循以下流程：

1. **理解需求**: 仔细阅读用户的需求描述
2. **分析现状**: 查看相关代码，理解当前实现
3. **设计方案**: 提出清晰、简洁的解决方案
4. **实现代码**: 编写符合规范的代码
5. **验证结果**: 确保代码正确性和完整性
6. **总结说明**: 简洁地说明完成的工作

---

## 附录：常用命令

### 开发命令

```bash
# 启动开发服务器（热更新）
./run_web
# 或
npm run dev

# 构建生产版本
npm run build

# 预览构建结果
npm run preview
# 或
./run_auto_preview

# 运行 E2E 测试
npm run test:e2e

# 运行单元测试
npm run test:unit

# 代码检查
npm run lint
```

### 项目结构查看

```bash
# 查看目录结构
tree -L 2 src/

# 查看组件列表
ls -la src/components/

# 查看页面列表
ls -la src/pages/
```

---

**文档版本**: 1.0  
**最后更新**: 2025-10-25  
**维护者**: 项目团队
