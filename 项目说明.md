# 前端说明 (Vue3 + Vite + Ionic)

## 技术栈
- 框架: Vue 3 (Composition API)
- 构建: Vite 5.4.19
- UI: Ionic Vue 8.7.3
- 语言: TypeScript 5.9.2
- 图标: Ionicons + Lucide Vue Next
- 测试: Cypress (e2e), Vitest (单元测试)
- 移动端: Capacitor 7.4.3

## 核心组件说明

### PageLikeModal.vue 全屏弹窗组件
这是项目的核心组件，为其他功能页面提供模拟页面的体验：

**功能特性:**
- 统一使用 IonModal 实现全屏弹窗
- 支持多种标题类型：simple、icon-tabs、text-tabs、auto（自动检测）
- 内置滑动退出动画（vertical模式支持垂直滑动，horizontal模式支持水平滑动）
- 支持标签页内容的懒加载和切换动画
- 集成 TabSwipeGesture 和 ModalSwipeGesture 组件进行手势处理
- 支持 Tab 状态持久化，用户关闭后重新打开可恢复到之前的 Tab
- 模态框层级管理和z-index控制
- 固定纯色不透明背景

### Tab 状态持久化系统
项目实现了 Tab 状态持久化功能：

**主要特性:**
- 使用 localStorage 存储各个模态框的 Tab 状态
- 支持多个模态框同时使用不同的持久化键
- 自动恢复用户上次选择的 Tab
- 通过 `modalType` prop 指定持久化键
- 通过 `enableTabPersistence` prop 控制是否启用（默认为 true）

**当前使用:**
- `GeneratorModal`: AI生成器模态框，使用 `modal-type="GeneratorModal"` 进行状态持久化

### 移动端特殊处理
项目针对移动端做了大量优化：

**历史控制:**
- 防止用户通过浏览器后退按钮离开应用
- Safari/iOS 特殊兼容性处理
- 支持应用内导航的同时阻止意外退出

**认证流程:**
- Google OAuth 支持弹窗和全页面两种模式
- Safari 阻止弹窗时自动降级到全页面认证
- 认证成功后的状态恢复和页面跳转处理

**性能优化:**
- 图片预加载和懒加载
- Skeleton 占位减少加载闪烁
- 分页数据预取提升滚动体验

**Props:**
- `isOpen: boolean` - 控制弹窗显示/隐藏
- `modalTitle?: string` - 页面标题（已废弃，使用pageTitle）
- `pageTitle?: string` - 页面标题
- `tabs?: TabItem[]` - 标签页配置
- `modelValue?: string` - 当前激活的标签页
- `swipeThresholdRatio?: number` - 滑动退出阈值比例，默认0.08
- `modalStyle?: 'vertical' | 'horizontal' | 'V' | 'H' | 'v' | 'h'` - 模态框样式模式，默认为horizontal
- `titleType?: 'icon-tabs' | 'text-tabs' | 'simple' | 'auto'` - 标题类型，支持auto自动检测
- `hotDismissed?: boolean` - 热门标签是否已关闭
- `enableTabSwipe?: boolean` - 是否启用 tab 切换滑动，默认为 false
- `disableContentScroll?: boolean` - 是否禁用内容区域的上下滑动，默认为 false
- `modalType?: string` - 模态窗口类型，用于tab状态持久化，如 'GeneratorModal'、'SettingsModal' 等
- `enableTabPersistence?: boolean` - 是否启用tab状态持久化，默认为 true

**使用示例:**
```vue
<PageLikeModal 
  :is-open="showPage" 
  page-title="Settings" 
  modal-style="vertical" 
  title-type="simple"
  @close="closePage"
>
  <div>页面内容</div>
</PageLikeModal>
```

### 项目页面架构
- **views/HomePage.vue**: 路由页面，包装 pages/homepage/index.vue
- **pages/homepage/index.vue**: 主页面实现，包含分类展示和图片浏览
- **pages/AuthPage.vue**: 基于 PageLikeModal 实现的认证页面
- **其他功能页面**: 均基于 PageLikeModal 实现，包括：
  - 侧边菜单页面 (sideMenu/): index.vue（侧边菜单主页）, PricingPage, PreferencesPage, 各种政策页面等
  - 用户中心页面 (userCenter/): index.vue（用户中心主页）, PaymentHistoryPage, UsageHistoryPage 等
  - 生成器页面 (generator/): index.vue（AI生成器页面，包含1P/20P/40P/80P标签页）

## 核心功能概览

### 数据加载策略
| 功能 | 说明 |
| ---- | ---- |
| 分类分页加载 | /api/demo_home 提供分页；前端维护 per-category page/hasMore 状态 |
| 预取下一页 | 用户浏览时后台请求下一页，提升滚动顺滑度 |
| 重试机制 | 指数退避 (400ms * 2^(n-1))，避免瞬时失败放弃 |
| 并发锁 | 首次加载 & 加载更多加锁，防止竞态重复请求 |
| Skeleton 占位 | 首屏自适应数量 + 加载更多阶段 2 个占位骨架 |
| 自适应 Skeleton 计算 | 基于 viewport 宽度 & 行数估算展示数量，窗口 resize 触发重算 |
| "No more content" 延迟显示 | 仅在已有真实数据并确定没有更多时显示 |

### 菜单系统
| 功能 | 说明 |
| ---- | ---- |
| 扁平化菜单 | 将主菜单和二级菜单转换为统一的FlatMenuItem数组进行管理 |
| 分类映射 | 每个菜单项对应特定的API分类，用于数据加载 |
| 手势导航 | 支持左右滑动切换菜单分类 |
| 状态同步 | 菜单切换时自动更新对应的主菜单和二级菜单状态 |

### 认证与会话管理
| 功能 | 说明 |
| ---- | ---- |
| Google OAuth | 集成完整的Google OAuth 2.0认证流程 |
| 会话心跳 | 页面可见时每10分钟自动刷新会话状态 |
| 会话持久化 | 支持长时间保持登录状态，包含滑动续期机制 |
| Safari兼容 | 针对Safari浏览器的特殊处理和兼容性优化 |
| 状态恢复 | 页面刷新后自动恢复认证状态和用户信息 | 自定义组件
- 语言: TypeScript
- 测试: Cypress (e2e), 基础单位测试示例 (`tests/unit`)

## 启动
开发（自动热更新）:
```
./run_web
```
预览（自动预览脚本）:
```
./run_auto_preview
```
后端需同时启动：
```
./run_server
```

## 目录结构简要
```
src/
  main.ts             # 入口文件
  App.vue             # 根组件，管理所有弹窗状态
  bootstrap/          # 应用启动模块
    index.ts          # 启动入口，整合所有启动模块
    appSetup.ts       # 应用实例创建和配置
    authHandler.ts    # 认证处理（全页面认证、会话刷新）
    globalEvents.ts   # 全局事件监听
    routeManager.ts   # 路由管理和应用挂载
    safariCompat.ts   # Safari 兼容性处理
  router/             # 路由定义，包含移动端历史控制
    index.ts          # 路由配置，只有 /home 路由
  components/
    pageLike/         # PageLikeModal 核心组件及其组合式函数
      PageLikeModal.vue           # 全屏弹窗基础组件
      ContentPageBase.vue         # 内容页面基础组件
      css/PageLikeModal.css       # 样式文件
      composables/                # 组合式函数
        useModalState.ts          # 模态框状态管理
        useModalMode.ts           # 模态框模式管理
        useTabManagement.ts       # 标签页管理
        useModalGestures.ts       # 手势处理
        useModalAnimation.ts      # 动画处理
    animation/        # 动画组件 (BaseAnimation, HorizontalAnimation, VerticalAnimation)
    backButton/       # 模态框返回按钮组件 (ReturnButton, CloseButton, BaseButton)
    button/           # 按钮组件 (LargePrimaryButton)
    cardList/         # 分页列表组件 (CardList, CardInfo, FiniteCardList3)
    category/         # 分类面板组件 (CategoryPanels, RetryButton)
    choiceItem/       # 选择项组件 (OptionsContainer, RadioOption)
    debug/            # 调试组件 (DebugPanel)
    dialog/           # 对话框组件 (ConfirmDialog)
    gesture/          # 手势交互组件 (ModalSwipeGesture, TabSwipeGesture, NativeScrollGesture)
    header/           # 页面头部组件
      HomeHeader.vue        # 主页头部
      ModalHeader.vue       # 模态框头部
    icons/            # 图标组件
      SvgIcon.vue           # SVG 图标组件
      ImgIcon.vue           # 图片图标组件
      IconComponents.ts     # 图标组件定义
      iconMap.ts            # 图标映射
      iconUtils.ts          # 图标工具函数
      README.md             # 图标使用说明
    layout/           # 布局组件
      AdaptiveContentArea.vue  # 自适应内容区域
      CenterCard.vue           # 居中卡片
      FixedBottomArea.vue      # 固定底部区域
      OptionCard.vue           # 选项卡片
      PreviewImageArea.vue     # 预览图片区域
      OptionsCardsArea/        # 选项卡片区域组件
        index.vue           # 主组件
        composables/           # 组合式函数
        README.md              # 说明文档
    modalTitle/       # 模态框标题组件 (IconTabsTitle, TextTabsTitle, SimpleTitle, AdaptiveTabsTitle)
    navBar/           # 导航栏相关组件
      MainNavBar.vue        # 主导航栏
      SubNavBar.vue         # 子导航栏
      MainItem.vue          # 主导航项
      SubItem.vue           # 子导航项
      menuController.ts     # 菜单控制器
    pill/             # 标签组件 (HotPill)
    popupLike/        # 弹窗类组件 (PopupLikeModal)
    toast/            # 提示组件 (MessageToast, LoadingToast)
    topBar/           # 顶部栏组件 (HomeTopBar, ModalTopBar)
    uploadPhoto/      # 上传区域组件
      FaceUploadArea.vue        # 上传区域
      FaceThumbBar.vue          # 缩略图栏
      FaceUploadController.vue  # 上传控制器
      types.ts                  # 类型定义
      composables/              # 组合式函数
        internal/               # 内部组合式函数
          useFaceUploadState.ts   # 上传状态管理
          useFaceUploadSync.ts    # 上传同步
          useFaceUploadActions.ts # 上传操作
      utils/                    # 工具函数
        recentFacesCache.ts     # 最近上传缓存
    uploading/        # 上传状态组件 (UploadProgressModal)
  composables/        # 组合式逻辑
    useAuthRequiredAction.ts  # 需要认证的操作处理
    usePersistentModal.ts     # 弹窗状态持久化
    useSessionHeartbeat.ts    # 会话心跳检测
    usePriceCalculation.ts    # 价格计算逻辑
    useUploadState.ts         # 上传状态管理
    useSwipeGesture.ts        # 滑动手势处理
    useViewportHeight.ts      # 视口高度管理
  constants/          # 常量定义
    upload.ts         # 上传相关常量
  popups/             # 弹窗对话框组件
    DebugPopup.vue        # 调试弹窗
  pages/              # 页面级组件
    authPage/         # 认证页面
      index.vue    # 认证页面主组件
      composables/    # 认证页面组合式函数
        useAuthError.ts      # 认证错误处理
        useAuthState.ts      # 认证状态管理
        useOAuthAuth.ts      # OAuth 认证逻辑
        usePolicyModals.ts   # 政策弹窗管理
    generator/        # AI 生成器相关页面
      index.vue       # 生成器主页面（包含多个Tab：1P、20P、40P、80P）
      composables/    # 生成器组合式函数
        useGeneratorActions.ts  # 生成器操作
        useGeneratorFaces.ts    # 人脸管理
        useGeneratorModals.ts   # 弹窗管理
        useGeneratorPlans.ts    # 计划管理
      tabContent/     # 各个Tab的具体内容组件
        Generator1P.vue    # 1P生成器Tab内容
        Generator20P.vue   # 20P生成器Tab内容 
        Generator40P.vue   # 40P生成器Tab内容
        Generator80P.vue   # 80P生成器Tab内容
      buttonArea/     # 按钮区域组件
        ButtonArea.vue     # 生成按钮区域
        PrimaryButton.vue  # 主按钮组件
        TaskETA.vue        # 任务耗时显示组件
      optionsPages/   # 选项页面组件
        OptionsPageBase.vue # 选项页面基础组件
        BackdropsPage.vue   # 背景选择页面
        PosesPage.vue       # 姿势选择页面
        OutfitsPage.vue     # 服装选择页面
        HairstylesPage.vue  # 发型选择页面
        composables/        # 选项页面组合式函数
    homepage/         # 主页面相关
      index.vue       # 主页面实现
      menuData.ts     # 菜单数据定义
      composables/    # 主页面组合式函数
        useEventHandlers.ts         # 事件处理
        useGeneratorIntegration.ts  # 生成器集成
        useLifecycleSetup.ts        # 生命周期设置
        useMenuManagement.ts        # 菜单管理
        usePreferencesManagement.ts # 偏好设置管理
        useScrollManagement.ts      # 滚动管理
        useUIManagement.ts          # UI管理
        useWatchers.ts              # 监听器
        dataManagement/             # 数据管理子模块
    sideMenu/         # 侧边菜单相关页面
      index.vue    # 侧边菜单主页面（已重构为组合式函数架构）
      composables/    # 侧边菜单组合式函数
        useSideMenuManagement.ts      # 主管理组合式函数
        useUserInfoManagement.ts      # 用户信息管理
        useMenuDataManagement.ts      # 菜单数据管理
        useMenuAnimationGestures.ts   # 动画、手势和弹性滚动管理
        useMenuEventHandlers.ts       # 事件处理管理
        menuAnimation/                # 动画子模块
      css/            # 样式文件
        SideMenuPage.css              # 侧边菜单样式
      data/           # 数据文件
        menuData.ts                   # 菜单配置数据
      PricingPage.vue # 定价页面
      PreferencesPage.vue # 偏好设置页面
      CookiePolicyPage.vue    # Cookie 政策页面
      PrivacyPolicyPage.vue   # 隐私政策页面
      RefundPolicyPage.vue    # 退款政策页面
      TermsOfServicePage.vue  # 服务条款页面
    uploadedPhotos/   # 已上传照片页面
      FaceUploadedPage.vue    # 已上传人脸页面
      faceSelectionCache.ts   # 人脸选择缓存
    userCenter/       # 用户中心相关页面
      index.vue       # 用户中心主页面
      PaymentHistoryPage.vue # 支付历史
      UsageHistoryPage.vue   # 使用历史
  services/           # 服务层
    imageService.ts         # 图片相关 API
    priceService.ts         # 价格服务
    rechargeService.ts      # 充值服务
    uploadedFacesService.ts # 已上传人脸服务
    userSettingsService.ts  # 用户设置服务
    faceUpload/             # 人脸上传服务子模块
      index.ts              # 导出接口
      uploader.ts           # 上传器
      imagePreprocessor.ts  # 图片预处理
      canvasUtils.ts        # Canvas 工具
      exifParser.ts         # EXIF 解析
      types.ts              # 类型定义
  state/              # 状态管理
    authState.ts          # 认证状态 (Google OAuth)
    uiState.ts            # UI 状态持久化
    newUserSettings.ts    # 新用户设置状态
  types/              # 类型定义
    generator.ts      # 生成器相关类型，包含 TabItem 接口定义
    userSettings.ts   # 用户设置相关类型
  utils/              # 工具函数
    historyControl.ts # 移动端历史控制
    homePageLock.ts   # 主页锁定功能
    layoutCapture.ts  # 布局捕获工具
    smartLoading.ts   # 智能加载工具
    zIndexManager.ts  # z-index层级管理
  views/              # 视图页面
    HomePage.vue      # 主页面路由包装
  theme/              # 样式主题
    variables.css     # CSS 变量
    mobile-navigation.css # 移动端导航样式
    generator-common.css  # 生成器通用样式
```

说明:
- bootstrap/ 包含应用启动相关的模块，负责初始化、认证处理、Safari 兼容性等
- components/pageLike/ 包含 PageLikeModal 核心组件及其相关的组合式函数，采用模块化设计
- pages/ 包含所有页面级组件，均基于 PageLikeModal 实现全屏弹窗体验
- pages/uploadedPhotos/ 包含已上传照片管理页面和人脸选择缓存功能
- sideMenu/ 和 userCenter/ 分别包含侧边菜单和用户中心的相关页面
- popups/ 包含弹窗对话框组件，与 PageLikeModal 不同，这些是传统的对话框样式
- gesture/ 包含手势交互组件，如 TabSwipeGesture（标签滑动切换）和 ModalSwipeGesture（模态框滑动退出）
- services/ 包含所有 API 调用服务，包括图片、价格、充值、用户设置等
- state/ 包含全局状态管理，包括认证状态、UI 状态、新用户设置等
- types/ 包含 TypeScript 类型定义，独立于实现
- 各个组件按功能分类组织，提供可复用的UI原子和复合组件
- 主页面使用组合式函数进行功能模块化，每个功能都有独立的 composable

## 核心功能概览
| 功能 | 说明 |
| ---- | ---- |
| 分类分页加载 | /api/demo_home 提供分页；前端维护 per-category page/hasMore 状态 |
| 预取下一页 | 用户浏览时后台请求下一页，提升滚动顺滑度 |
| 重试机制 | 指数退避 (400ms * 2^(n-1))，避免瞬时失败放弃 |
| 并发锁 | 首次加载 & 加载更多加锁，防止竞态重复请求 |
| Skeleton 占位 | 首屏自适应数量 + 加载更多阶段 2 个占位骨架 |
| 自适应 Skeleton 计算 | 基于 viewport 宽度 & 行数估算展示数量，窗口 resize 触发重算 |
| “No more content” 延迟显示 | 仅在已有真实数据并确定没有更多时显示 |

## 状态管理说明
当前未引入 Vuex/Pinia，使用 `reactive`/`ref` + 模块化 state：
- `authState.ts`: 登录 / 会话信息 (Google OAuth 认证集成)
  - 支持会话刷新和自动登录
  - 包含用户信息 (sub, email, name, picture, coin_balance 等)
- `uiState.ts`: 全局 UI 控制（各种弹窗的可见性等）
  - 使用 sessionStorage 持久化状态
  - 支持页面刷新后状态恢复

弹窗状态管理通过 `usePersistentModal` composable 实现：
- 自动从 uiState 读取初始值
- 变更时写回 uiState 并持久化到 sessionStorage
- 支持附带数据字段的同步持久化

若复杂度提升，可渐进迁移至 Pinia：
1. 先为现有 state 定义类型接口
2. 新建 pinia store 平行返回 get/set API
3. 组件逐步替换导入源

## 服务层 (services)
统一封装后端请求，利于：
- 错误集中处理
- 后续切换 baseURL 或加鉴权 header

注意：分页函数需返回标准结构 `{ images, page, has_more }` 以避免组件层解耦中断。

## API 交互点
| 前端服务 | 后端接口 | 说明 |
| -------- | -------- | ---- |
| imageService | /api/demo_home | 分类分页列表 |
| imageService | /api/demo_faces | Faces 示例 |
| priceService | /api/prices, /api/recharge_rules | 价格与充值规则 |
| userSettingsService | /api/new_user | 新用户初始设置 |
| uploadedFacesService | /api/upload/faces/all | 获取用户所有已上传的人脸列表 |
| faceUpload services | /api/upload | 上传图片 (multipart) |
| authState | /api/auth/google/* | Google OAuth 认证流程 |
| authState | /api/auth/session | 会话信息获取（包含最近上传的人脸，最多4张） |
| authState | /api/auth/session?include=all | 会话信息获取（包含所有已上传的人脸） |
| authState | /api/auth/sessions | 列出用户所有会话 |
| authState | /api/auth/logout | 登出当前会话 |
| authState | /api/auth/logout_all | 登出所有会话 |
| authState | /api/auth/logout_session | 登出指定会话 |
| health (可选) | /api/health | 探活 (非 prod 同时有 /api/_routes) |

## 加载与性能策略
- 首屏：Skeleton 覆盖减少空白闪烁
- 预取：一页成功后立即请求下一页（若存在 & 未在加载）
- 去重：利用 Map/Set 跟踪正在加载的分类 / 已预取页码
- 失败恢复：重试上限后暴露“Retry”按钮（`RetryButton.vue`）

## 类型系统说明
项目使用 TypeScript 提供完整的类型支持：

### 核心类型定义 (`types/`)
- `types/generator.ts`: 生成器相关类型
  - `TabItem`: 标签项接口，包含 key、label、icon、hot 等属性
  - `GeneratorProps`: 生成器组件属性接口
- `types/userSettings.ts`: 用户设置相关类型
  - `NewUserSettings`: 新用户初始设置接口
  - `PlanType`: 计划类型 ('20P' | '40P' | '80P')
  - `OptionType`: 选项类型 ('backdrops' | 'hairstyles' | 'poses' | 'outfits')

### 页面级类型定义
- `pages/homepage/menuData.ts`: 主页菜单类型
  - `MenuItem`: 主菜单项接口，包含 id、name、displayName 和可选的 subMenus
  - `SubMenuItem`: 子菜单项接口，包含 id、name、displayName
  - `FlatMenuItem`: 扁平化菜单项接口，用于导航和数据加载
  - `HOME_MENU_CONFIG`: 菜单配置数组，定义了完整的菜单层级结构
- `components/uploadPhoto/types.ts`: 上传相关类型
  - `FaceUploadExpose`: 上传控制器暴露的接口
  - `CachedPhotoItem`: 缓存照片项接口

### 类型检查
- 严格的 TypeScript 配置 (strict: true)
- 构建时进行完整的类型检查
- 所有 Vue 组件都使用 `<script setup lang="ts">` 语法
- 类型定义独立于实现，放在 `types/` 目录下

## 代码约定
| 类别 | 约定 |
| ---- | ---- |
| 组件命名 | PascalCase (`HomeHeader.vue`, `CategoryPanels.vue`) |
| 组合函数 | use 前缀 (`usePersistentModal`) |
| 服务函数 | 动词开头 (`fetchDemoHomePage`, `uploadImage`) |
| CSS 变量 | 统一放 `theme/variables.css` |
| 响应式 | 使用 `ref`/`reactive`，避免直接在模板中复杂表达式重复计算 |
| 类型定义 | 统一放在 `types/` 目录下，使用 interface 而非 type |

## 样式 / 适配
- 使用 Ionic 组件基础布局，补充自定义 CSS (mobile-navigation.css)
- Skeleton 高度与卡片保持一致，避免加载后跳动
- 通过 viewport 计算列数：可根据容器宽度 / 期望卡片宽度实现（当前逻辑在 CardList 里）

## 测试 (前端)
### E2E (Cypress)
- `cypress.config.ts` 已在根目录
- 典型用例：首屏加载显示 skeleton -> 数据填充 -> 滚动触发加载更多 -> No more content

### 单元 / 组件测试
- `tests/unit/example.spec.ts` 示例
- 推荐后续加入：CardList skeleton 计算、prefetch 逻辑 mock

## 环境变量 (Vite)
可使用 `.env.development`, `.env.production`：
```
VITE_API_BASE=http://127.0.0.1:5010
VITE_ENABLE_DEBUG=true
```
在代码里：`import.meta.env.VITE_API_BASE`

## 构建与部署
构建：
```
npm run build
```
产物：`dist/` (可交给静态服务器或集成至后端 Nginx)

## 常见问题 (FAQ)
| 问题 | 可能原因 | 处理 |
| ---- | -------- | ---- |
| 图片加载 404 | 后端未启动 / 路径前缀缺失 | 检查 `VITE_API_BASE` 或服务器端口 |
| Skeleton 不消失 | 首次请求失败且未重试成功 | 查看控制台 / 使用 Retry 按钮 |
| 重复图片 | Demo 模式后端按 TOTAL 重复轮询 | 真实数据阶段替换后端实现 |

## 后续改进建议
- 引入 Pinia 管理复杂全局状态
- 使用 IntersectionObserver 更精细触发预取
- 添加请求取消 (AbortController) 防止快速切换浪费
- PWA：缓存静态资源与部分 API 响应
- 组件级性能：虚拟列表 (大量图片时)
- 图片懒加载 / 占位模糊图 (LQIP)

## 变更历史摘要（前端加载相关）
1. 本地图示数据迁移到后端分页接口
2. 加入预取 + 退避重试 + 并发锁
3. Skeleton：首屏自适应 + 加载更多占位
4. “No more content” 条件延迟显示

5. 集成 Google OAuth 认证系统
6. 添加移动端历史控制和 Safari 兼容性
7. 实现扁平化菜单系统和导航逻辑

## 应用启动流程 (bootstrap/)
项目使用模块化的启动流程，各个模块职责清晰：

### 启动模块
- `bootstrap/index.ts`: 启动入口，整合所有启动模块
- `bootstrap/appSetup.ts`: 创建 Vue 应用实例，注册 Ionic 和路由
- `bootstrap/authHandler.ts`: 处理全页面认证和会话刷新
- `bootstrap/globalEvents.ts`: 全局事件监听（预留）
- `bootstrap/routeManager.ts`: 路由管理和应用挂载
- `bootstrap/safariCompat.ts`: Safari 兼容性处理

### 启动顺序
1. 初始化 UI 状态持久化
2. 创建应用实例
3. 处理认证（全页面认证、会话刷新）
4. Safari 兼容性设置
5. 挂载应用

## 移动端特殊处理
项目针对移动端做了大量优化：

### 历史控制
- 防止用户通过浏览器后退按钮离开应用
- Safari/iOS 特殊兼容性处理
- 支持应用内导航的同时阻止意外退出

### 认证流程
- Google OAuth 支持弹窗和全页面两种模式
- Safari 阻止弹窗时自动降级到全页面认证
- 认证成功后的状态恢复和页面跳转处理

### 性能优化
- 图片预加载和懒加载
- Skeleton 占位减少加载闪烁
- 分页数据预取提升滚动体验

## 已上传照片管理
项目实现了完整的已上传照片管理功能：

### 核心功能
- `pages/uploadedPhotos/FaceUploadedPage.vue`: 已上传人脸页面
  - 显示用户所有已上传的人脸照片
  - 支持多选和单选
  - 显示照片过期时间（30天）
  - 支持直接上传新照片
- `pages/uploadedPhotos/faceSelectionCache.ts`: 人脸选择缓存
  - 使用 localStorage 持久化选择状态
  - 支持跨页面同步选择状态
  - 按用户隔离缓存数据

### 选择状态同步
- `FaceThumbBar` 和 `FaceUploadedPage` 之间双向同步
- 使用共享的 `faceSelectionCache` 实现状态持久化
- 页面刷新后自动恢复选择状态
- 支持超过 4 张照片的选择（FaceThumbBar 只显示前 4 张）

### 缓存机制
- `components/uploadPhoto/utils/recentFacesCache.ts`: 最近上传缓存
  - 缓存最近上传的照片（最多 4 张）
  - 按用户隔离缓存
  - 支持持久化和清除
- `pages/uploadedPhotos/faceSelectionCache.ts`: 选择状态缓存
  - 缓存用户选择的照片 URL
  - 支持无限数量的选择
  - 按用户隔离缓存

### 人脸上传服务 (services/faceUpload/)
项目实现了完整的人脸上传预处理流程：

- `uploader.ts`: 上传器，处理文件上传到服务器
- `imagePreprocessor.ts`: 图片预处理
  - 自动旋转（根据 EXIF 方向）
  - 压缩和格式转换（WebP）
  - 尺寸调整
- `canvasUtils.ts`: Canvas 工具函数
- `exifParser.ts`: EXIF 数据解析
- `types.ts`: 类型定义

这个模块确保上传的图片符合服务器要求，同时优化文件大小和质量。

## 新用户设置功能
项目实现了新用户初始设置功能，为不同 plan 提供默认的选项卡片选择数量：

### 功能说明
- 用户登录后自动从服务端获取新用户设置
- 为 20P、40P、80P 三种 plan 提供默认的选项卡片选择数量
- 每种 plan 包含 4 种选项：backdrops、hairstyles、poses、outfits

### 实现架构
- `services/userSettingsService.ts`: 调用 `/api/new_user` 接口
- `state/newUserSettings.ts`: 管理新用户设置状态
- `types/userSettings.ts`: 类型定义
- 登录后自动加载设置（在 `authState.ts` 中）

### 使用方式
```typescript
import { getOptionsCardSelNumber } from '@/state/newUserSettings';

// 获取 20P plan 的 backdrops 默认选择数量
const defaultCount = getOptionsCardSelNumber('20P').backdrops;
```

## 菜单系统说明
项目使用扁平化菜单系统 (`pages/homepage/menuData.ts`)：

### 菜单结构
- 主菜单: HOT, Studio, Office, Workplace, City, Nature
- 二级菜单: Studio (Dark/Light), Office (Luxury/Small), Workplace (Open Space/Person Desk)
- 扁平化处理: 所有菜单项转换为统一的 FlatMenuItem 数组

### 导航逻辑
- 支持主菜单和二级菜单的联动
- 滑动切换时自动更新对应的菜单状态
- 每个菜单项对应一个 API 分类进行数据加载
- 使用 useMenuManagement 组合式函数管理菜单状态和切换逻辑

## 组合式函数架构说明
项目大量使用组合式函数（Composables）进行功能模块化：

### PageLikeModal 组合式函数
- `useModalState`: 管理模态框的基础状态（显示/隐藏、层级等）
- `useModalMode`: 管理模态框的显示模式（垂直/水平）
- `useTabManagement`: 管理标签页的状态和切换逻辑
- `useModalGestures`: 处理模态框的手势交互
- `useModalAnimation`: 管理模态框的进入/退出动画

### 主页面组合式函数
- `useMenuManagement`: 管理菜单状态和导航逻辑
- `useDataManagement`: 管理数据加载、缓存和分页
- `usePreferencesManagement`: 管理用户偏好设置
- `useGeneratorIntegration`: 管理与生成器的集成
- `useUIManagement`: 管理UI状态和交互

### 侧边菜单组合式函数
- `useSideMenuManagement`: 主管理组合式函数（整合所有功能）
- `useUserInfoManagement`: 用户信息管理（头像、姓名、金币等）
- `useMenuDataManagement`: 菜单数据管理（配置、选中状态等）
- `useMenuAnimationGestures`: 动画、手势和弹性滚动管理（打开/关闭、滑动、弹性滚动等）
- `useMenuEventHandlers`: 事件处理管理（点击、导航等）

### 认证页面组合式函数
- `useAuthError`: 认证错误处理
- `useAuthState`: 认证状态管理
- `useOAuthAuth`: OAuth 认证逻辑
- `usePolicyModals`: 政策弹窗管理

### 生成器组合式函数
- `useGeneratorActions`: 生成器操作
- `useGeneratorFaces`: 人脸管理
- `useGeneratorModals`: 弹窗管理
- `useGeneratorPlans`: 计划管理

### 全局组合式函数
- `usePersistentModal`: 提供弹窗状态持久化功能
- `useSessionHeartbeat`: 管理用户会话心跳检测
- `usePriceCalculation`: 处理价格计算逻辑
- `useUploadState`: 管理文件上传状态
- `useAuthRequiredAction`: 需要认证的操作处理
- `useSwipeGesture`: 滑动手势处理
- `useViewportHeight`: 视口高度管理

这种架构使得代码更加模块化、可复用和易于测试。

---
若需英文文档，可新增 `FRONTEND_README.en.md`。