问题：
审查 GeneratorModal、FaceUploadController 的代码，确保没有操作“faces 上传图片列表”、“faces 选择图片列表”的逻辑。如果有，则把这些逻辑移动到 FaceThumbBar 里。

---

# Faces 列表管理职责重构

## 重构目标

确保 GeneratorModal 和 FaceUploadController 不直接操作"faces 上传图片列表"和"faces 选中图片列表"，这些逻辑应该由 `useFaceUploadState` 和 `FaceThumbBar` 管理。

## 重构前的问题

### 1. GeneratorModal 的问题

**问题**：GeneratorModal 维护了 `uploadedState`，包含 `uploaded` 和 `selected` 两个列表

```typescript
// ❌ 问题代码
const uploadedState = ref<UploadedState>({
  uploaded: [],  // 上传的图片列表
  selected: []   // 选中的图片列表
});

// GeneratorModal 直接操作这些列表
uploadedState.value = { uploaded: [], selected: [] };
```

**影响**：
- 违反单一职责原则
- GeneratorModal 不应该知道具体的图片 URL
- 导致状态管理混乱

### 2. FaceUploadedPage 的问题

**问题**：依赖父组件传入 `selected-urls`

```vue
<!-- ❌ 问题代码 -->
<FaceUploadedPage
  :selected-urls="uploadedState.selected"
  @selection-change="handleFaceLibrarySelectionChange"
/>
```

**影响**：
- 选择状态在父组件和子组件之间传递
- 增加了不必要的耦合

## 重构后的架构

### 职责划分

```
┌─────────────────────────────────────────────────────────────┐
│ GeneratorModal (src/pages/generator/index.vue)             │
│                                                             │
│ 职责：                                                       │
│ - 只知道选中的图片数量（用于计算价格）                        │
│ - 不知道具体的图片 URL                                       │
│ - 不操作 faces 列表                                          │
│                                                             │
│ 数据：uploadedFacesCount: number                            │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    只接收数量事件
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ FaceUploadController                                        │
│                                                             │
│ 职责：                                                       │
│ - 传递 props 和事件                                          │
│ - 不直接操作列表                                             │
│                                                             │
│ 事件：uploadedCountChange(count: number)                    │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    委托给 useFaceUploadState
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ useFaceUploadState                                          │
│                                                             │
│ 职责：                                                       │
│ - 管理 recentUploadedUrls（最新上传的 4 张）                 │
│ - 管理 selectedUploadedUrls（选中的图片，从 localStorage）   │
│ - 计算 uploadedImageUrls（显示列表）                         │
│                                                             │
│ 数据：                                                       │
│ - recentUploadedUrls: Ref<string[]>                        │
│ - selectedUploadedUrls: Ref<string[]>                      │
│ - uploadedImageUrls: ComputedRef<string[]>                 │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    提供显示列表和选中列表
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ FaceThumbBar                                                │
│                                                             │
│ 职责：                                                       │
│ - 显示图片（最多 4 张）                                       │
│ - 处理用户点击切换选中状态                                    │
│ - 保存选中状态到 localStorage                                │
│                                                             │
│ Props：                                                     │
│ - images: string[]（显示的图片）                             │
│ - selectedList: string[]（选中的图片）                       │
│                                                             │
│ Events：                                                    │
│ - selectionChange({ selected, count })                     │
└─────────────────────────────────────────────────────────────┘
                            ↓
                    保存到 localStorage
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ localStorage (faceSelectionCache)                           │
│                                                             │
│ 职责：                                                       │
│ - 持久化选中状态                                             │
│ - 跨页面共享选择状态                                          │
│                                                             │
│ Key: faceSelection_{userId}                                 │
│ Value: string[] (选中的图片 URL)                             │
└─────────────────────────────────────────────────────────────┘
```

## 重构内容

### 1. GeneratorModal (src/pages/generator/index.vue)

**修改前**：
```typescript
const uploadedState = ref<UploadedState>({
  uploaded: [],
  selected: []
});

const handleUploadedStateChange = (payload: { uploaded: string[]; selected: string[] }) => {
  uploadedState.value = payload;
};
```

**修改后**：
```typescript
const uploadedFacesCount = ref<number>(0);

const handleUploadedCountChange = (count: number) => {
  uploadedFacesCount.value = count;
  updatePlanSelectionCount(currentPlanKey.value, count);
};
```

**移除**：
- `uploadedState` ref
- `selected-urls` prop 传递给 FaceUploadedPage
- `selection-change` 事件处理

### 2. useGeneratorFaces.ts

**修改前**：
```typescript
const uploadedState = ref<UploadedState>({
  uploaded: [],
  selected: []
});

const handleUploadedStateChange = (
  payload: { uploaded: string[]; selected: string[] },
  updatePlanSelectionCount: (plan: PlanKey, count?: number) => void
) => {
  uploadedState.value = {
    uploaded: [...payload.uploaded],
    selected: [...payload.selected]
  };
  updatePlanSelectionCount(currentPlanKey.value, uploadedState.value.selected.length);
};
```

**修改后**：
```typescript
const uploadedFacesCount = ref<number>(0);

const handleUploadedCountChange = (
  count: number,
  updatePlanSelectionCount: (plan: PlanKey, count?: number) => void
) => {
  uploadedFacesCount.value = count;
  updatePlanSelectionCount(currentPlanKey.value, count);
};
```

### 3. FaceUploadController Types

**修改前**：
```typescript
export interface FaceUploadControllerEmits {
  uploadedStateChange: [{ uploaded: string[]; selected: string[] }];
}
```

**修改后**：
```typescript
export interface FaceUploadControllerEmits {
  uploadedCountChange: [count: number];
}
```

### 4. useFaceUploadState.ts

**修改前**：
```typescript
const emitStateChange = () => {
  emit('uploadedStateChange', {
    uploaded: uploadedImageUrls.value,
    selected: selectedUploadedUrls.value
  });
};
```

**修改后**：
```typescript
const emitStateChange = () => {
  // 只发送选中的数量，不发送具体的 URL 列表
  emit('uploadedCountChange', selectedUploadedUrls.value.length);
};
```

### 5. FaceUploadedPage.vue

**修改前**：
```vue
<script setup lang="ts">
interface Props {
  isOpen: boolean;
  selectedUrls?: string[];
}

const emit = defineEmits<{
  close: [];
  'selection-change': [selected: string[]];
}>();

const emitSelection = (urls: string[]) => {
  emit('selection-change', urls);
};
</script>
```

**修改后**：
```vue
<script setup lang="ts">
interface Props {
  isOpen: boolean;
}

const emit = defineEmits<{
  close: [];
}>();

// 不再需要向父组件发送选择状态，完全由 localStorage 管理
</script>
```

## 数据流

### 选择状态的流动

```
用户点击 FaceThumbBar 中的图片
    ↓
FaceThumbBar.onSlotClick()
    ↓
saveFaceSelection(list) → localStorage
    ↓
emit('selectionChange', { selected: list, count: list.length })
    ↓
useFaceUploadState.handleThumbSelectionChange()
    ↓
updateSelection(list) → selectedUploadedUrls.value = list
    ↓
emitStateChange() → emit('uploadedCountChange', count)
    ↓
GeneratorModal.handleUploadedCountChange()
    ↓
uploadedFacesCount.value = count
    ↓
updatePlanSelectionCount() → 更新价格计算
```

### 跨页面同步

```
FaceThumbBar 选中图片
    ↓
saveFaceSelection() → localStorage
    ↓
打开 FaceUploadedPage
    ↓
onMounted() → loadFaceSelection() ← localStorage
    ↓
显示选中状态
    ↓
用户修改选择
    ↓
saveFaceSelection() → localStorage
    ↓
关闭 FaceUploadedPage
    ↓
refreshThumbBar() → loadFaceSelection() ← localStorage
    ↓
FaceThumbBar 更新显示
```

## 优势

### 1. 职责清晰

- ✅ GeneratorModal：只关心数量，用于价格计算
- ✅ useFaceUploadState：管理列表数据
- ✅ FaceThumbBar：显示和交互
- ✅ localStorage：持久化

### 2. 解耦

- ✅ GeneratorModal 不知道具体的图片 URL
- ✅ FaceUploadedPage 不依赖父组件传入的选择状态
- ✅ 选择状态完全由 localStorage 管理

### 3. 可维护性

- ✅ 单一数据源（localStorage）
- ✅ 清晰的数据流
- ✅ 易于测试和调试

### 4. 性能

- ✅ 减少不必要的数据传递
- ✅ 只传递必要的数量信息
- ✅ 避免大数组的复制

## 测试要点

1. ✅ GeneratorModal 只接收选中的数量
2. ✅ FaceThumbBar 正确保存选择状态到 localStorage
3. ✅ FaceUploadedPage 从 localStorage 加载选择状态
4. ✅ 跨页面选择状态同步正确
5. ✅ 价格计算基于正确的数量

## 总结

通过这次重构：

- **移除了** GeneratorModal 中的 `uploadedState`
- **简化了** 事件传递（从 `uploadedStateChange` 到 `uploadedCountChange`）
- **解耦了** FaceUploadedPage 和父组件
- **集中了** 选择状态管理到 localStorage
- **明确了** 各组件的职责边界

现在的架构更加清晰、可维护，符合单一职责原则。
