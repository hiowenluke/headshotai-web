较大的优化，先问问 Kiro 是否有必要。



# 我

很好，现在，我们有两种列表，主页里的卡片列表，和 FaceUploadedPage 里的卡片列表。

那么：

1. FaceUploadedPage 有无必要 也使用 主页使用的卡片列表 组件？

2. 是否需要改造主页使用的卡片列表，使它更具有通用性，例如支持 3列、4列布局，支持支持卡片的宽高比例，支持在右下角显示简化的时间戳？或者，其实应该把 FaceUploadedPage 里的卡片列表提取出来，变成一个通用的卡片列表，以专门满足类似 FaceUploadedPage 这样的页面（例如后续还会有 BackdropUPloadedPage、OutfitUploadedPage 等）的需求？



# Kiro——建议保持现状

好问题！让我分析一下这两种列表的差异和使用场景：

。。。

## 两种卡片列表对比分析

### 1️⃣ 主页卡片列表 (CardList.vue + CardInfo.vue)

#### 特点：

- ✅ 列布局（固定）
- 4:3 宽高比（竖向卡片）
- ❌ 无限滚动加载
- ✅ Skeleton 加载动画
- ✅ 卡片缓存优化
- ✅ 选中标记（右上角）
- ❌ 时间戳显示
- ❌ 自定义网格布局
- ❌ 加号卡片（上传入口）
- ❌ 动态注释没有实现
- ❌ 列数不可配置

#### 使用场景：

- 主页（Backdrops 浏览）
- OptionsPage（Backdrops/Hairstyles/Outfits/Poses 选择）

### 2️⃣ FaceUploadedPage 卡片列表

#### 特点：

- ✅ 3列布局（固定）
- ✅ 1:1 宽高比（正方形卡片）
- ✅ 选中标记（右上角）
- ✅ 时间戳显示（右下角）
- ✅ 自定义网格布局
- ✅ 加号卡片（上传入口）
- ❌ 无限滚动
- ❌ 无 Skeleton 加载
- ❌ 列数不可配置

#### 使用场景：

- FaceUploadedPage（已上传的人脸）
- 未来：BackdropUploadedPage, OutfitUploadedPage 等

## 我的建议

基于你提到的未来需求（BackdropUploadedPage, OutfitUploadedPage），我建议：

### 方案：创建一个通用的 UploadedItemsGrid 组件

**理由**

1. **需求差异明显**：
   - 主页列表：2列；4:5比例，无限滚动，大量数据
   - 上传列表：3列；1:1比例，很少数据，需要时间戳

2. **未来扩展性**：
   - BackdropUploadedPage, OutfitUploadedPage 会有相似需求
   - 都需要显示上传时间，过期时间
   - 都需要加号卡片作为上传入口

3. **避免过度抽象**：
   - 把 CardList 改造成支持所有场景会让它变得复杂
   - 两种列表的核心需求不同，强行统一会增加维护成本

---

## 推荐实现方案

**创建新组件：** `UploadedItemsGrid.vue`

```
src/components/uploadedItems/
├── UploadedItemsGrid.vue    # 网格容器（支持配置列数、宽高比）
└── UploadedItemCard.vue      # 单个卡片（支持时间戳、选中状态）
```

**特性**：

- ✅ 可配置列数（2/3/4列）
- ✅ 可配置宽高比（1:1 / 4:5 等）
- ✅ 支持时间戳显示（可选）
- ✅ 支持加号卡片
- ✅ 选中状态管理
- ✅ 简洁的 API

使用示例：

```html
<UploadedItemsGrid
  :items="faces"
  :columns="3"
  :aspect-ratio="1"
  :selected-urls="selectedUrls"
  show-expiry-label
  show-add-button
  @toggle="handleToggle"
  @add="handleUpload"
/>
```

---

### 具体建议

#### ✅ 保持 CardList.vue 专注于主页场景

- 继续优化无限滚动，有序缓存
- 保持 2列，4:5 比例
- 不增加过多配置项

#### ✅ 创建 UploadedItemsGrid 专注于上传管理场景

- 支持 3列（或可配置）
- 1:1 正方形卡片
- 显示时间戳、过期信息
- 加号卡片入口

#### ✅ 共用底层样式和逻辑

- 选中状态的视觉样式可以共享
- Checkmark 组件可以提取为独立组件
- 卡片阴影、圆角等样式可以统一

### 🤔 需要你确认

1. 是否需要现在就创建 UploadedItemsGrid？ 还是等到真正需要 BackdropUploadedPage 时再重构？
2. UploadedItemsGrid 的优先级？ 是否需要先完成其他功能？
3. 列数配置需求？ FaceUploadedPage 是否需要支持 2列/4列切换？

我们向产品先保现状，等到真正需要第二个 UploadedPage 时再提取通用组件，避免过早优化。你觉得呢？



# 我——采纳建议

“先保持现状”，你的建议很好。

那么，我们先只对 FaceUploadedPage 的卡片列表做个简单优化，像 主页 的卡片列表那样，第一次打开时，计算卡片列表的位置、卡片大小和位置，保存到 localStorage 里，以后直接使用这些数据。



# Kiro

好的！让我为 FaceUploadedPage 添加布局缓存优化。由于它使用的是 3列 1:1 正方形布局，我会参考 CardList 的实现方式：

。。。

完成! ✅

## 优化总结

已为 FaceUploadedPage 添加了布局缓存优化，实现方式与 CardList 类似但针对其 3 列正方形布局进行了调整。

### 实现内容

1. 布局缓存机制
   - 缓存 Key：`card_layout_face-uploaded_v1_{viewport}`
   - 缓存内容：卡片尺寸 (cardSize)
   - 视口分桶：20px 粒度

2. 测量与更新
   - 组件挂载时读取缓存
   - 数据加载完成后测量实际尺寸
   - 窗口大小变化时重新测量
   - 尺寸变化超过 1px 时更新缓存

3. 触发时机
   - `onMounted`: 读取缓存并监听 resize
   - `watch(faces.length)`: 首次加载完成后测量
   - 延迟测量：100ms 和 500ms 两次，确保图片加载完成

### 优化效果

- ✅ 减少首次打开时的布局抖动
- ✅ 后续打开立即应用正确布局
- ✅ 不同视口宽度独立缓存
- ✅ 完全向后兼容，失败时静默降级

### 文档

详细实现文档已保存在 `docs/FACE_UPLOADED_PAGE_OPTIMIZATION.md`

所有代码已通过类型检查！🎉

