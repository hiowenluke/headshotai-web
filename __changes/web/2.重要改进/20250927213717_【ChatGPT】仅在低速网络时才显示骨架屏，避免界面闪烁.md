# 我

加上骨架屏之后，在 Slow 4G 下，先显示骨架屏，然后显示正式的页面，效果很好。但是在快速网络环境下，反而会因为有骨架屏一闪而过（因为瞬间就被正式界面替换了），看起来画面有闪烁感。

如何优化？例如，在 index.html里，从进入就开始计时 200毫秒，到时间就检测 DOM 有无加载完毕，如果没有，就显示骨架屏，否则就不显示骨架屏。这样呢？

或者你有无其他更好的方案？



# ChatGPT

。。。

先把思路梳理给你：

- 初始我们让 skeleton 处于 `is-delayed` 状态，CSS 中把它设为不可见；
- 进入页面马上启动一个 200 ms 的定时器：到时如果应用还没挂载（[window.__appMounted](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 仍为 `false`），就移除 `is-delayed`，真正显示骨架屏；
- 一旦 Vue 应用挂载完成，[main.ts](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 会触发 [window.__hideAppShell()](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)，在这个函数里我们会：
  - 标记 [window.__appMounted = true](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)，未来任何延迟展示都不会再触发；
  - 清理那 200 ms 的定时器；
  - 给 skeleton 加上原来的淡出动画并在 400 ms 后移除 DOM。

这样慢网速时，骨架屏仍会在 200 ms 后出现并撑住首屏；快网速下，应用在 200 ms 内完成挂载并调用 [__hideAppShell](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)，骨架屏根本不会亮相，自然也就没有闪烁。

### 具体改动

| 文件                                                         | 说明                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [index.html](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) | ✦ Skeleton 容器默认带 `is-delayed` 类并新增对应 CSS（隐藏元素）；✦ 注入一个自执行脚本，负责 200 ms 延迟检测、记录 [window.__appMounted](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)、以及在应用就绪时清除骨架；✦ 保留原来的 [__hideAppShell](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 淡出动画逻辑。 |

### 使用与调整

- 如果想延长或缩短等待阈值，只需调节脚本里的 `200` 常量即可；
- 若将来还需要其他触发条件（例如后台数据比 UI 加载慢），可以在同一个函数里补充检测逻辑；
- 若希望在“绝不展示 skeleton”的场景直接移除 DOM，可在 [__hideAppShell](vscode-file://vscode-app/Applications/Visual Studio Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) 内判定 `shell.classList.contains('is-delayed')` 时立即 `removeChild`。

当前改法在慢网速下依旧展示骨架，在快网速下不闪烁，也保留了你之前调校的排版和配色。如还有其它体验优化想法，随时告诉我！
